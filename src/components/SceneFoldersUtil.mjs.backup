import { BACK_BUTTON_OPTIONS, getSettings } from "../constants/Settings.mjs";
import { MODULE_ID } from "../constants/General.mjs";
import { HOOKS_CORE } from "../constants/Hooks.mjs";
import { GeneralUtil } from "./GeneralUtil.mjs";
import { LogUtil } from "./LogUtil.mjs";
import { SettingsUtil } from "./SettingsUtil.mjs";
import { TopNavigation } from "./TopNavUtil.mjs";
import { Sortable } from "sortablejs";

const DEFAULT_FOLDER_ID = "root";

/**
 * Manages scene navigation folders in the UI, providing functionality for folder organization,
 * selection, and display of scene folders.
 */
export class SceneNavFolders {
  static selectedFolder = DEFAULT_FOLDER_ID;
  static #currSceneSortMode = "a";
  static #toggledFolders = [];

  /**
   * Initializes the scene folders functionality by setting up event hooks
   * @static
   */
  static init() {
    if (SceneNavFolders.noFolderView() || !ui.scenes) { return; }
    SceneNavFolders.preloadTemplates();
    SceneNavFolders.folderListData = SceneNavFolders.getFolders(ui.scenes.folders);
    SceneNavFolders.selectedFolder = SceneNavFolders.selectFolder(DEFAULT_FOLDER_ID);
    
    // Register a hook to save toggled folders state when the game is saved
    Hooks.on(HOOKS_CORE.READY, () => {
      // Attempt to load saved toggled folders from user flags
      const savedToggledFolders = game.user.getFlag(MODULE_ID, "toggledFolders");
      if (savedToggledFolders) {
        SceneNavFolders.#toggledFolders = savedToggledFolders;
      }
    });
  }

  /**
   * Add Scene folders to scene navigation bar
   * @param {SceneNavigation} nav - The scene navigation instance
   * @param {HTMLElement} navHtml - The navigation HTML element
   * @param {SceneNavData} navData - The scene navigation data
   */
  static addFolderButtons(nav, navHtml, navData){
    const SETTINGS = getSettings();
    const activeScenesMenu = navHtml.querySelector("#scene-navigation-active");
    const firstActiveItem = activeScenesMenu.querySelector("li.scene:first-of-type");
    const folderLookup = document.createElement("div");
    const folderToggle = document.createElement("div");

    folderLookup.id = "crlngn-scene-lookup";
    folderLookup.dataset.tooltip = `Search Scenes`;
    folderLookup.innerHTML = `<button class='folder-expand'><i class='fa-solid fa-magnifying-glass'></i></button>`;
    folderToggle.id = "crlngn-folder-toggle";
    folderToggle.dataset.tooltip = TopNavigation.navShowRootFolders ? `Hide Scene Folders` : `Show Scene Folders`;
    folderToggle.innerHTML = `<i class='fa-solid icon'></i>`;

    if(TopNavigation.navShowRootFolders){
      activeScenesMenu.classList.add('with-folders');
    }else{
      activeScenesMenu.classList.remove('with-folders');
    }

    folderLookup.addEventListener("click", SceneNavFolders.toggleFolderLookup);
    folderToggle.addEventListener("click", ()=>{
      TopNavigation.setNavPosition(0);
      SettingsUtil.set(SETTINGS.navShowRootFolders.tag, !TopNavigation.navShowRootFolders );
    });
    activeScenesMenu.insertBefore(folderLookup, firstActiveItem);
    activeScenesMenu.append(folderToggle);
  }

  // static addRootFolders(){
  //   const rootFolders = document.createElement("li");
  //   rootFolders.id = "root-folders";
  //   rootFolders.classList.add('folder');
    
  //   const templateData = SceneNavFolders.buildFolderData(DEFAULT_FOLDER_ID);
    
  // }

  static renderFolderList = async(folderElement) => {
    let targetElement;
    const allFolders = ui.scenes.collection.folders;
    const folder = folderElement ? allFolders.get(folderElement.dataset.folderId) : { name: "", id: DEFAULT_FOLDER_ID };
    const templateData = SceneNavFolders.buildTemplateData(folder);
    const renderedHtml = await renderTemplate(
      `modules/${MODULE_ID}/templates/scene-nav-root-folders.hbs`, 
      templateData
    );

    LogUtil.log("renderedHtml",[renderedHtml]);

    if(!folderElement){ // if root folder
      targetElement = document.querySelector("#scene-navigation-inactive");
    }else{
      targetElement = folderElement.parentNode();
    }
    targetElement.insertAdjacentHTML('afterbegin', renderedHtml);

    const folderItems = targetElement.querySelectorAll("li.folder");
    folderItems.forEach(item => {
      const folderId = item.querySelector(".folder-item").dataset.folderId;
      
      // Check if this folder should be active based on toggledFolders array
      if (folderId && SceneNavFolders.#isFolderToggled(folderId)) {
        item.classList.add('crlngn-folder-active');
      }
      
      item.querySelector(".folder-item").addEventListener('click', SceneNavFolders.#onNavFolderClick);
    });
  }

  /**
   * Event for when user expands the folder lookup element
   * @param {Event} event 
   */
  static toggleFolderLookup(event){
    
  }

  /**
   * Checks if a folder is currently toggled (active)
   * @param {string} folderId - The ID of the folder to check
   * @returns {boolean} True if the folder is toggled
   * @private
   */
  static #isFolderToggled(folderId) {
    return SceneNavFolders.#toggledFolders.includes(folderId);
  }

  /**
   * Toggles a folder's active state and updates the toggledFolders array
   * @param {string} folderId - The ID of the folder to toggle
   * @param {boolean} active - Whether the folder should be active
   * @private
   */
  static #toggleFolderState(folderId, active) {
    const index = SceneNavFolders.#toggledFolders.indexOf(folderId);
    
    if (active && index === -1) {
      // Add to toggled folders if active and not already in array
      SceneNavFolders.#toggledFolders.push(folderId);
    } else if (!active && index !== -1) {
      // Remove from toggled folders if inactive and in array
      SceneNavFolders.#toggledFolders.splice(index, 1);
    }
    
    // Save toggled folders state to user flags
    if (game.user) {
      game.user.setFlag(MODULE_ID, "toggledFolders", SceneNavFolders.#toggledFolders);
    }
    
    LogUtil.log("toggleFolderState", [SceneNavFolders.#toggledFolders]);
  }

  static #onNavFolderClick = async (event) => {
    event.preventDefault();
    event.stopPropagation();
    const target = event.currentTarget;
    const activeFolders = document.querySelectorAll('.crlngn-folder-active');
    activeFolders.forEach(item => {
      if(item !== target){
        item.classList.remove('crlngn-folder-active');
      }
    });

    const id = target.dataset.folderId;
    const allFolders = ui.scenes.collection.folders;
    const folder = id ? allFolders.get(id) : null;

    LogUtil.log("onNavFolderClick",[folder, id]);
    if(!folder){ return; }

    const folderData = SceneNavFolders.buildTemplateData(folder);
    const renderedSubfolders = await renderTemplate(
      `modules/${MODULE_ID}/templates/scene-nav-subfolders.hbs`, 
      folderData
    );
    const contents = target.parentNode.querySelector(".contents");
    if(contents) contents.remove();
    target.parentNode.insertAdjacentHTML('beforeend', renderedSubfolders);

    const folderItems = target.parentNode.querySelectorAll("li.folder");
    folderItems.forEach(item => {
      item.querySelector(".folder-item").addEventListener('click', SceneNavFolders.#onNavFolderClick);
    });
    TopNavigation.addSceneListeners(target.parentNode);
    
    // target.parentNode.style.setProperty('--parent-offset-left', offsetLeft + 'px');
    const isActive = target.parentNode.classList.contains('crlngn-folder-active');
    
    LogUtil.log("onNavFolderClick",[isActive]);
    if(isActive) {
      target.parentNode.classList.remove('crlngn-folder-active');
      // Store folder id in toggledFolders array
      SceneNavFolders.#toggleFolderState(id, true);
    } else {
      target.parentNode.classList.add('crlngn-folder-active');
      // Remove folder id from toggledFolders array
      SceneNavFolders.#toggleFolderState(id, false);
    }
  }

  /**
   * Selects a folder by its ID
   * @param {string} id - The ID of the folder to select
   * @returns {object|null} The selected folder object or null if not found
   */
  static selectFolder = (id) => {
    return SceneNavFolders.getFolderById(id) || null;
  }

  /**
   * Builds template data for a folder
   * @param {Directory} targetFolder - The folder to build data for
   * @returns {object} Template data for the folder
   */
  static buildTemplateData(targetFolder){
    if(!targetFolder || !ui.scenes) return {};
    const allFolders = ui.scenes.collection.folders;
    let templateData = {}, folderList = [];
    let folderScenes = targetFolder.contents ? [...targetFolder.contents] : []; 
    folderScenes = folderScenes.filter(sc => sc.permission >= 2); // only show scenes with appropriate permission

    SceneNavFolders.#currSceneSortMode = game.scenes.sortingMode;
    LogUtil.log("buildTemplateData",[targetFolder, folderScenes]);
    // Folder-specific data
    if (targetFolder.id === DEFAULT_FOLDER_ID) {
      folderList = allFolders.filter(f => f.folder===null) || [];
    } else {
      folderList = targetFolder.children;
    }

    folderList = SceneNavFolders.sortFolderList(folderList); // adjust the sorting
    
    // Add isActive property to each folder based on toggledFolders array
    folderList = folderList.map(folder => {
      return {
        ...folder,
        name: folder.name || folder.folder.name,
        id: folder.id || folder.folder.id,
        isActive: SceneNavFolders.#isFolderToggled(folder.id)
      };
    });
    
    templateData = {
      currentFolder: targetFolder,
      folders: folderList,
      scenes: folderScenes
    };

    LogUtil.log("buildTemplateData B", [folderList, templateData]);

    return templateData;
  }

  /**
   * Determines if the folder view should be hidden based on user permissions and settings
   * @returns {boolean} True if folder view should be hidden
   */
  static noFolderView = () => {
    const isGM = game?.user?.isGM;
    return (!isGM && !TopNavigation.navFoldersForPlayers) ||
      (!TopNavigation.navFoldersEnabled) ||
      (!TopNavigation.sceneNavEnabled)
  }

  /**
   * Preloads the Handlebars template for scene folder list
   * @returns {Promise<boolean>} True when template is successfully loaded
   */
  static preloadTemplates = async () => {
    const templatePath = [
      `modules/${MODULE_ID}/templates/scene-nav-root-folders.hbs`,
      `modules/${MODULE_ID}/templates/scene-nav-subfolders.hbs`
    ];
    
    // This returns an object with paths as keys and template functions as values
    await loadTemplates(templatePath);
  
    return true;
  }

  static sortFolderList(folderList){
    // folderList = folderList.map((f,i) => {
    //   if(f.folder && !f.id){
    //     return f.folder;
    //   }else{
    //     return f;
    //   }
    // });
    LogUtil.log("sortFolderList", [folderList]);

    if(SceneNavFolders.#currSceneSortMode === "a"){ // alphabetical sort order
      folderList.sort((a, b) => {
        return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
      });
    }else{ // manual sort order
      folderList.sort((a, b) => a.sort - b.sort);
    }
    
    return folderList;
  }
}